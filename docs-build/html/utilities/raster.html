<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Raster &mdash; aatoolbox  documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->

        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/sphinx_highlight.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="AA Toolbox API" href="../api.html" />
    <link rel="prev" title="Utilities" href="../utilities.html" />
</head>

<body class="wy-body-for-nav">
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> aatoolbox
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quickstart.html">Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="../config.html">Country Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../datasources.html">Data Sources</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../utilities.html">Utilities</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">Raster</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#background">Background</a></li>
<li class="toctree-l3"><a class="reference internal" href="#usage">Usage</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#accessor">Accessor</a></li>
<li class="toctree-l4"><a class="reference internal" href="#raster-statistics">Raster statistics</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#properties">Properties</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../api.html">AA Toolbox API</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../license.html">License</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">aatoolbox</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a></li>
          <li class="breadcrumb-item"><a href="../utilities.html">Utilities</a></li>
      <li class="breadcrumb-item active">Raster</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/utilities/raster.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">

  <section id="raster">
<h1>Raster<a class="headerlink" href="#raster" title="Permalink to this heading"></a></h1>
<section id="background">
<h2>Background<a class="headerlink" href="#background" title="Permalink to this heading"></a></h2>
<p>This module extends xarray and rioxarray to provide
additional functionality for raster processing and
post-processing. These are used throughout the
datasources to process various raster data, but are
also useful directly for the end user, and is thus
available for direct use. The extension is based on the
guidance for how to <a class="reference external" href="http://xarray.pydata.org/en/stable/internals/extending-xarray.html">extend xarray</a>.</p>
</section>
<section id="usage">
<h2>Usage<a class="headerlink" href="#usage" title="Permalink to this heading"></a></h2>
<section id="accessor">
<h3>Accessor<a class="headerlink" href="#accessor" title="Permalink to this heading"></a></h3>
<p>To make the extension accessible, you only need to import
<code class="docutils literal notranslate"><span class="pre">aatoolbox</span></code> directly. Then, extension methods and properties
are simply accessed using <code class="docutils literal notranslate"><span class="pre">da.aat.method()</span></code> or
<code class="docutils literal notranslate"><span class="pre">da.aat.property</span></code> on a data array or dataset.  As a simple
example, we can create a data array that has
incorrect coordinates (ascending latitude and descending
longitude). Then we can use the extension to invert them to
the correct ordering.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">xarray</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">aatoolbox</span>

<span class="n">da</span> <span class="o">=</span> <span class="n">xarray</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span>
  <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span>
  <span class="n">coords</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;lat&quot;</span><span class="p">:</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">87</span><span class="p">,</span> <span class="mi">88</span><span class="p">,</span> <span class="mi">89</span><span class="p">,</span> <span class="mi">90</span><span class="p">]),</span>
          <span class="s2">&quot;lon&quot;</span><span class="p">:</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">70</span><span class="p">,</span> <span class="mi">69</span><span class="p">,</span> <span class="mi">68</span><span class="p">,</span> <span class="mi">67</span><span class="p">])}</span>
<span class="p">)</span>
<span class="n">da_inv</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">aat</span><span class="o">.</span><span class="n">invert_coordinates</span><span class="p">()</span>

<span class="c1"># check they have inverted</span>
<span class="n">da_inv</span><span class="o">.</span><span class="n">get_index</span><span class="p">(</span><span class="s2">&quot;lon&quot;</span><span class="p">)</span>
<span class="c1">#&gt; Int64Index([67, 68, 69, 70], dtype=&#39;int64&#39;, name=&#39;lon&#39;)</span>
<span class="n">da_inv</span><span class="o">.</span><span class="n">get_index</span><span class="p">(</span><span class="s2">&quot;lat&quot;</span><span class="p">)</span>
<span class="c1">#&gt; Int64Index([90, 89, 88, 87], dtype=&#39;int64&#39;, name=&#39;lat&#39;)</span>
</pre></div>
</div>
</section>
<section id="raster-statistics">
<h3>Raster statistics<a class="headerlink" href="#raster-statistics" title="Permalink to this heading"></a></h3>
<p>One of the more useful functionalities of the module
is providing an easy ability to calcuate raster statistics
across a specified set of geometries defined in a geodataframe.
Paired with the administrative boundaries and raster data sources
available through this library, we can easily calculate
raster statistics.</p>
<p>A full snippet of example code is available below.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">aatoolbox</span>
<span class="kn">import</span> <span class="nn">datetime</span>

<span class="c1"># load the administrative boundaries</span>
<span class="n">country_config</span> <span class="o">=</span> <span class="n">aatoolbox</span><span class="o">.</span><span class="n">create_country_config</span><span class="p">(</span><span class="n">iso3</span><span class="o">=</span><span class="s2">&quot;eth&quot;</span><span class="p">)</span>
<span class="n">codab</span> <span class="o">=</span> <span class="n">aatoolbox</span><span class="o">.</span><span class="n">CodAB</span><span class="p">(</span><span class="n">country_config</span><span class="p">)</span>
<span class="n">codab</span><span class="o">.</span><span class="n">download</span><span class="p">()</span>
<span class="n">codab_eth</span> <span class="o">=</span> <span class="n">codab</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">admin_level</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="c1"># get geobounding box for CHIRPS downloading</span>
<span class="n">geo_bounding_box</span> <span class="o">=</span> <span class="n">aatoolbox</span><span class="o">.</span><span class="n">GeoBoundingBox</span><span class="o">.</span><span class="n">from_shape</span><span class="p">(</span><span class="n">codab_eth</span><span class="p">)</span>

<span class="c1"># load CHIRPs data for processing</span>
<span class="n">start_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="n">year</span><span class="o">=</span><span class="mi">2001</span><span class="p">,</span> <span class="n">month</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">day</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">end_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="n">year</span><span class="o">=</span><span class="mi">2006</span><span class="p">,</span> <span class="n">month</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">day</span><span class="o">=</span><span class="mi">31</span><span class="p">)</span>

<span class="n">chirps_monthly</span> <span class="o">=</span> <span class="n">ChirpsMonthly</span><span class="p">(</span>
    <span class="n">country_config</span><span class="o">=</span><span class="n">country_config</span><span class="p">,</span>
    <span class="n">geo_bounding_box</span><span class="o">=</span><span class="n">geo_bounding_box</span><span class="p">,</span>
    <span class="n">start_date</span><span class="o">=</span><span class="n">start_date</span><span class="p">,</span>
    <span class="n">end_date</span><span class="o">=</span><span class="n">end_date</span>
    <span class="p">)</span>

<span class="n">chirps_monthly</span><span class="o">.</span><span class="n">download</span><span class="p">()</span>
<span class="n">chirps_monthly</span><span class="o">.</span><span class="n">process</span><span class="p">()</span>
<span class="n">chirps_monthly_data</span> <span class="o">=</span> <span class="n">chirps_monthly</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>

<span class="c1"># compute raster statistics</span>

<span class="n">chirps_monthly_data</span><span class="o">.</span><span class="n">aat</span><span class="o">.</span><span class="n">compute_raster_stats</span><span class="p">(</span>
  <span class="n">gdf</span><span class="o">=</span><span class="n">codab_eth</span><span class="p">,</span>
  <span class="n">feature_col</span><span class="o">=</span><span class="s2">&quot;ADM2_PCODE&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="properties">
<h2>Properties<a class="headerlink" href="#properties" title="Permalink to this heading"></a></h2>
<p>The user should be careful when accessing attributes of
a data array when using the raster module. This module
builds on <cite>rioxarray &lt;https://corteva.github.io/rioxarray&gt;_</cite>
extensions, and thus methods and attributes accessible
via <code class="docutils literal notranslate"><span class="pre">da.rio.method()</span></code>  or <code class="docutils literal notranslate"><span class="pre">da.rio.property</span></code> are
also accessible using <code class="docutils literal notranslate"><span class="pre">da.aat.method()</span></code> or
<code class="docutils literal notranslate"><span class="pre">da.aat.property</span></code>. However, original rioxarray properties
should be accessed using <code class="docutils literal notranslate"><span class="pre">da.rio.property</span></code>.</p>
<p>Let’s create a simple data array where we want to specify
the spatial dimensions explicitly because the coordinate
names are not automatically detected.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">xarray</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">aatoolbox</span>

<span class="n">da</span> <span class="o">=</span> <span class="n">xarray</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span>
    <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span>
    <span class="n">coords</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;a&quot;</span><span class="p">:</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">90</span><span class="p">,</span> <span class="mi">89</span><span class="p">,</span> <span class="mi">88</span><span class="p">,</span> <span class="mi">87</span><span class="p">]),</span>
            <span class="s2">&quot;b&quot;</span><span class="p">:</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">70</span><span class="p">,</span> <span class="mi">69</span><span class="p">,</span> <span class="mi">68</span><span class="p">,</span> <span class="mi">67</span><span class="p">])}</span>
<span class="p">)</span>
</pre></div>
</div>
<p>We can set the spatial dimensions using
<code class="docutils literal notranslate"><span class="pre">da.rio.set_spatial_dims()</span></code> or call it directly
from <code class="docutils literal notranslate"><span class="pre">da.aat</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">da_new</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">aat</span><span class="o">.</span><span class="n">set_spatial_dims</span><span class="p">(</span>
  <span class="n">x_dim</span><span class="o">=</span><span class="s2">&quot;a&quot;</span><span class="p">,</span>
  <span class="n">y_dim</span><span class="o">=</span><span class="s2">&quot;b&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
<p>However, even though we can set the dimensions
using either accessor, we have to be careful
accessing the properties.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">da_new</span><span class="o">.</span><span class="n">rio</span><span class="o">.</span><span class="n">x_dim</span>
<span class="c1">#&gt; &#39;a&#39;</span>

<span class="n">da_new</span><span class="o">.</span><span class="n">aat</span><span class="o">.</span><span class="n">x_dim</span>
<span class="c1">#&gt; MissingSpatialDimensionError: x dimension not found.</span>
<span class="c1">#&gt; &#39;rio.set_spatial_dims()&#39; or using &#39;rename()&#39; to change</span>
<span class="c1">#&gt; the dimension name to &#39;x&#39; can address this.</span>
</pre></div>
</div>
<p>Even though the method was called using <code class="docutils literal notranslate"><span class="pre">aat</span></code>, the property
is not accessible through it. Users need to be careful about
accessing rioxarray properties using the <code class="docutils literal notranslate"><span class="pre">aat</span></code> accessor.</p>
<p>For best practice, rioxarray methods and properties should all
be accessed using <code class="docutils literal notranslate"><span class="pre">rio</span></code>. These properties are <code class="docutils literal notranslate"><span class="pre">rio.x_dim</span></code>,
<code class="docutils literal notranslate"><span class="pre">rio.y_dim</span></code>, <code class="docutils literal notranslate"><span class="pre">rio.shape</span></code>, <code class="docutils literal notranslate"><span class="pre">rio.width</span></code>, <code class="docutils literal notranslate"><span class="pre">rio.height</span></code>, and
<code class="docutils literal notranslate"><span class="pre">rio.crs</span></code>. This module’s methods and properties should be
accessed using the <code class="docutils literal notranslate"><span class="pre">aat</span></code> accessor. These properties are
<code class="docutils literal notranslate"><span class="pre">aat.t_dim</span></code> and <code class="docutils literal notranslate"><span class="pre">aat.longitude_range</span></code>.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../utilities.html" class="btn btn-neutral float-left" title="Utilities" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../api.html" class="btn btn-neutral float-right" title="AA Toolbox API" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, Centre for Humanitarian Data Predictive Analytics Team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.


</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

</body>
</html>
